// maildrop - v0.2.0 - 12/29/2014
// 
// ; Licensed 
(function(a){function f(a,b,c){var d,g=Array.prototype.slice;c.length>0?e(b,function(){var b=c[0]();f(a,b,g.call(c,1))}):e.chain(b,a)}var b=a.document,c=a.XMLHttpRequest,d=a.setTimeout,e=a.when,$=a.$,g=Object.create({init:function(){return this.objects={},this.promises={},this.loadedAs={},this.paths={script:"src/",data:"data/"},this},set:function(a,b){this.objects[a]=b},get:function(a){return this.objects[a]},type:function(a){return typeof a=="string"?this.loadedAs[a]:a.type},fixPath:function(a,b){return this.paths[a]+b},guessType:function(a){return/\.(png|jpg|jpeg$)/i.test(a)?"image":/\.txt$/i.test(a)?"text":/\.json$/i.test(a)?"json":"data"},chain:function(a,b){var c=e.defer();return f(c,a,Array.prototype.slice.call(arguments,1)),c},script:function(c){var f,g;if(this.promises[c])return this.promises[c];if(!this.objects[c]){f=$('script[src="'+this.fixPath("script",c)+'"]')[0];if(f)return g=e.defer(),g.resolve(),this.objects[c]=f,this.promises[c]=g.promise,this.promises[c]}return f=a.document.createElement("script"),g=e.defer(),this.objects[c]=f,this.promises[c]=g.promise,f.onload=function(){d(function(){f.promise?f.promise.then(g.resolve.bind(g,f)):g.resolve(f)},0)},f.src=this.fixPath("script",c),b.head.appendChild(f),g.promise},module:function(a,b,c){this.objects[a]||(this.objects[a]=$('script[src="'+this.fixPath("script",a)+'"]')[0]),b?(this.objects[a].promise=b,b.then(c)):c()},text:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="text",this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.responseText,d.resolve(b.responseText)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.send(),d.promise},data:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="data",this.promises[a]=d.promise,b.onload=function(){this.objects[a]=b.response,d.resolve(b.response)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.responseType="arraybuffer",b.send(),d.promise},json:function(a){if(this.promises[a])return this.promises[a];var b=new c,d=e.defer();return this.loadedAs[a]="json",this.promises[a]=d.promise,b.onload=function(){try{this.objects[a]=JSON.parse(b.responseText)}catch(c){console.error("failed to parse "+a),console.error(c.toString())}d.resolve(b.responseText)}.bind(this),b.onerror=function(){d.reject()},b.open("GET",this.fixPath("data",a)),b.send(),d.promise},image:function(a){if(this.promises[a])return this.promises[a];var b=new Image,c=e.defer();return this.loadedAs[a]="image",this.promises[a]=c.promise,b.onload=function(){this.objects[a]=b,c.resolve(b)}.bind(this),b.onerror=function(){c.reject()},b.src=this.fixPath("data",a),c.promise},load:function(a){return typeof a=="string"?this[this.guessType(a)](a):this[a.type](a.path)},"package":function(a){function h(a){if(!a)return;var d;c+=a.length;for(d=0;d<a.length;d++)g.load(a[d]).then(function(a){console.log(a,g.type(a)),g.type(a)=="json"&&h(g.get(a).files),c--,c==0&&b.resolve()}.bind(this,a[d]))}if(this.promises[a])return this.promises[a];var b=e.defer(),c=0,d=/^{/,f;return typeof a=="object"?(h(a.files),c==0&&b.resolve()):d.test(a.trim())?(f=JSON.parse(a),h(f.files),c==0&&b.resolve()):g.json(a).then(function(){h(g.get(a).files),c==0&&b.resolve()}),this.promises[a]=b.promise,b.promise},definition:function(a){function b(a,c){return c.file&&b(a,g.get(c.file)),jQuery.extend(!0,a,c)}return b({},a)}}).init();a.load=g})(this),function(a,b){function g(a,c){var d=b.get(c);d.promise?d.promise.then(a.resolve.bind(a,d)):a.resolve(d)}var c=a.setTimeout,d=a.when,e=["engine/init.js","engine/math.js","engine/base.js","engine/object.js","engine/graphics.js","engine/physics.js","engine/sound.js","game/glider.js","game/jet.js","game/planet.js","game/mail.js","game/main.js"],f;e.forEach(function(a){var e=d.defer();b.set(a,{}),b.promises[a]=e,c(g.bind(null,e,a),0)})}(this,this.load),function(a){var b=a.when,c=a.aqua={};c.type=function(a,b,c,d){c=c||{},d=d||{};var e={},f;e.prototype=Object.create(a.prototype||{},c);for(f in b)e.prototype[f]=b[f];e.prototype.init||(e.prototype.init=function(){});for(f in d)e[f]=d[f];return e.create||(e.create=function(){var a=Object.create(e.prototype);return a.init.apply(a,arguments),a}),e},c.type.Base=c.type({},{}),c.extend=function(a,b){for(var c in b)a[c]=b[c];return a},c.requestAnimFrame=function(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b,c){a.setTimeout(b,1e3/60)}}(),c.PriorityItem=c.type(c.type.Base,{init:function(a,b,c,d,e){this.callback=a,this.priority=b||0,this.before=c||!1,this.once=d||!1,this.rate=e||1/60,this.sinceLast=0},call:function(){this.callback.apply(null,arguments)}}),c.PriorityList=c.type(c.type.Base,{init:function(){this.items=[]},add:function(a){var b=0,c=!1;for(;b<this.items.length;b++)if(a.before&&this.items[b].priority>=a.priority||!a.before&&this.items[b].priority>a.priority){this.items.splice(b,0,a),c=!0;break}c||this.items.push(a)},remove:function(a){var b=this.items.indexOf(a);return b!=-1&&this.items.splice(b,1),this},callAll:function(){var a=this.items,b=0,c;for(;b<a.length;b++)c=a[b],c.call.apply(c,arguments),c.once&&(a.splice(b,1),b--)}}),c.Emitter=c.type(c.type.Base,{on:function(a,b){this._events||(this._events={}),this._events[a]||(this._events[a]=[]),this._events[a].indexOf(b)==-1&&this._events[a].push(b)},off:function(a,b){var c=-1;this._events||(this._events={}),this._events[a]&&(c=this._events[a].indexOf(b))&&this._events[a].splice(c,1)},call:function(a){this._events||(this._events={});if(this._events[a]){var b=[],c,d=this._events[a];for(c=1;c<arguments.length;c++)b.push(arguments[c]);for(c=0;c<d.length;c++)d[c].apply(this,b)}}}),c.query=function(a,b){var c=location.search.substring(1).split("&"),d,e;for(d=0;d<c.length;d++){e=c[d].split("=");if(e[0]==a)return unescape(e[1])}return b}}(this),function(a){Math.mag=function(a,b){return Math.sqrt(a*a+b*b)},Math.lerp=function(a,b,c){return(b-a)*c+a},Math.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)}}(this),function(a,b){var c=b.type(b.type.Base,{init:function(){this.objects=[],this.tasks=b.PriorityList.create(),this.task(this.call.bind(this,"update")),this.task(this.call.bind(this,"lateUpdate"),c.Priorities.LATE_UPDATE)},add:function(a){a.game=this,this.objects.push(a),a.ongameadd&&a.ongameadd(this),a.call("ongameadd",a,this)},destroy:function(a){this.task(function(){var b=this.objects.indexOf(a);b!=-1&&(a.ongamedestroy&&a.ongamedestroy(this),a.call("ongamedestroy",a,this),a.game=null,this.objects.splice(b,1))}.bind(this),c.Priorities.GARBAGE,!1,!0)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.objects,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e.call.apply(e,arguments)},task:function(a,c,d,e){var f=b.PriorityItem.create.apply(b.PriorityItem,arguments);return this.tasks.add(f),f},step:function(){this.tasks.callAll(this)},main:function(){},pause:function(){},resume:function(){}},{},{Priorities:{UPDATE:0,LATE_UPDATE:5,RENDER:10,GARBAGE:20}}),d=b.type(b.type.Base,{init:function(){this.components=[]},add:function(a){return a.gameObject=this,this.components.push(a),a.onadd(this),this.game&&a.ongameadd(this,this.game),a},get:function(a){var b=this.components,c=b.length,d=a.prototype,e,f;for(f=0;f<c;f++){e=b[f];if(d.isPrototypeOf(e))return e}return null},destroy:function(a){function b(){var b=this.components.indexOf(a);b!=-1&&(a.ondestroy(this),this.game&&a.ongamedestroy(this,this.game),a.gameObject=null,this.components.splice(b,1))}this.game?this.game.task(b.bind(this),c.Priorities.GARBAGE,!1,!0):b.call(this)},call:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.components,d=c.length,e,f;for(f=0;f<d;f++)e=c[f],e[a]&&e[a].apply(e,b)}}),e=b.type(b.Emitter,{onadd:function(a){},ongameadd:function(a,b){},ondestroy:function(a){},ongamedestroy:function(a,b){}});b.Game=c,b.GameObject=d,b.Component=e}(this,this.aqua),function(a,b,c){b.module("engine/graphics.js",b.script("engine/object.js"),function(){var d=a.setTimeout,e=a.when,f=a.mat4,g=c.type(c.type.Base,{init:function(a){this.canvas=a,this.drawCalls=c.PriorityList.create(),this.shaders={},this.deferred=e.defer(),this.projection=f.identity(f.create()),this.modelview=f.identity(f.create()),this.matrix=f.create(),e(this.initContext(),this.deferred.resolve.bind(this.deferred)),e(this.deferred,function(){this.last=Date.now(),this.sinceLast=0}.bind(this))},initContext:function(){function b(){this.gl=this.canvas.getContext("experimental-webgl",{antialias:!1}),this.gl?a.resolve(this):d(b.bind(this),0)}var a=e.defer();return b.call(this),a.promise},draw:function(){if(!this.gl)return;var a=Date.now();this.sinceLast+=(a-this.last)/1e3,this.last=a,this.sinceLast>=.05&&this.drawCalls.callAll(this,this.gl);while(this.sinceLast>=.05)this.sinceLast-=.05},addDrawCall:function(a){return this.drawCalls.add(a),this},removeDrawCall:function(a){return this.drawCalls.remove(a),this},addShader:function(a){if(this.shaders[a.name])return this.shaders[a.name].promise;var c=e.defer();return this.shaders[a.name]=a,a.promise=c.promise,e.chain(e.all([this.deferred.promise,b.text(a.path+".vs"),b.text(a.path+".fs")],this._buildProgram.bind(this,a)),c),a.promise},_buildProgram:function(a){var c=this.gl,d=a.program=c.createProgram(),e;a.vertexShader=e=c.createShader(c.VERTEX_SHADER),c.shaderSource(e,b.get(a.path+".vs")),c.compileShader(e),c.attachShader(d,e),a.fragmentShader=e=c.createShader(c.FRAGMENT_SHADER),c.shaderSource(e,b.get(a.path+".fs")),c.compileShader(e),c.attachShader(d,e),c.linkProgram(d)},useShader:function(a){this.gl.useProgram(this.shaders[a].program)},addTexture:function(a){},useTexture:function(a,b){b=b||0},drawSquare:function(a){var b=!!a.cache,c=b?a.cache.buffer:!1,d=b?a.cache.array:!1,e=b?a.cache.view:!1,f=this.gl;c||(c=f.createBuffer(),d=new ArrayBuffer(96),e=new Float32Array(d),b&&(a.cache.buffer=c,a.cache.array=d,a.cache.view=e));var g=a.angle,h=a.center[0],i=a.center[1],j=a.size[0]/2,k=a.size[1]/2,l=a.color||[255,90,48,255],m=Math.mag(j,k),n=Math.atan2(k,j),o=Math.cos(g+n),p=Math.sin(g+n),q=Math.cos(g-n),r=Math.sin(g-n),s=Math.cos(g+Math.PI+n),t=Math.sin(g+Math.PI+n),u=Math.cos(g+Math.PI-n),v=Math.sin(g+Math.PI-n),w=this.shaders.basic;this.useShader("basic"),w.matrixLocation||(w.matrixLocation=f.getUniformLocation(w.program,"modelview_projection"),w.texture0Location=f.getUniformLocation(w.program,"texture0"),w.colorLocation=f.getUniformLocation(w.program,"color"),w.positionLocation=f.getAttribLocation(w.program,"a_position"),w.texcoord0Location=f.getAttribLocation(w.program,"a_texcoord0"),f.enableVertexAttribArray(w.positionLocation),f.enableVertexAttribArray(w.texcoord0Location)),e[0]=h+o*m,e[1]=i+p*m,e[4]=h+q*m,e[5]=i+r*m,e[8]=h+s*m,e[9]=i+t*m,e[12]=e[0],e[13]=e[1],e[16]=e[8],e[17]=e[9],e[20]=h+u*m,e[21]=i+v*m,f.bindBuffer(f.ARRAY_BUFFER,c),f.bufferData(f.ARRAY_BUFFER,e,f.DYNAMIC_DRAW),f.uniformMatrix4fv(w.matrixLocation,!1,this.projection),f.uniform4f(w.colorLocation,l[0]/255,l[1]/255,l[2]/255,l[3]/255),f.uniform1i(w.texture0Location,0),f.vertexAttribPointer(w.positionLocation,2,f.FLOAT,!1,16,0),f.vertexAttribPointer(w.texcoord0Location,2,f.FLOAT,!1,16,8),f.drawArrays(f.TRIANGLES,0,6)},destroyCache:function(a){a.buffer&&(this.gl.deleteBuffer(a.buffer),delete a.buffer)}}),h=c.type(c.Component,{ongameadd:function(a,b){this.drawCall=c.PriorityItem.create(this.draw.bind(this)),b.graphics.addDrawCall(this.drawCall)},ongamedestroy:function(a,b){b.graphics.removeDrawCall(this.drawCall)},draw:function(a,b){}});c.graphics=[],c.initGraphics=function(){var a=g.create.apply(null,arguments);return c.graphics.push(a),a},c.color=function(a){return[a.substring(0,2),a.substring(2,4),a.substring(4,6),a.substring(6,8)].map(function(a){return parseInt(a,16)})},c.Renderer=h})}(this,this.load,this.aqua),function(a,b){var c=a.ArrayBuffer,d=a.Float32Array,e=a.Uint8Array,f=a.when,g=a.aqua,h=a.vec3;b.module("engine/physics.js",f.all([b.script("engine/object.js"),b.script("engine/math.js")]),function(){function k(a,b,c){return b+c*a.cellsWide}var a=2,b=1,f=0,i=g.type(g.Emitter,{init:function(a,b,c){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.apply(this),this.position=a.slice(),this.lastPosition=a.slice(),this.oldPosition=a.slice(),this.velocity=[0,0,0],this.acceleration=[0,0,0],this.angle=0,this.maxVelocity=5,this.temporaryPosition=a.slice(),this.radius=b,this.mass=c*b*b,this.mask=i.Masks.LIQUID,this.collisionMask=i.Masks.ALL,this.friction=f},integrate:function(c){this.isStatic||(h.set(this.position,this.temporaryPosition),h.add(h.subtract(h.scale(this.position,a,this.position),h.scale(this.lastPosition,b,this.lastPosition),this.position),h.scale(this.acceleration,c*c,this.acceleration),this.position),h.set(this.temporaryPosition,this.lastPosition)),this.x=this.position[0],this.y=this.position[1],this.lx=this.lastPosition[0],this.ly=this.lastPosition[1],this.velocity[0]=this.position[0]-this.lastPosition[0],this.velocity[1]=this.position[1]-this.lastPosition[1],h.dot(this.velocity,this.velocity)>this.maxVelocity*this.maxVelocity&&(this.velocity=h.scale(h.normalize(this.velocity),this.maxVelocity),this.x=this.lastPosition[0]+this.velocity[0],this.y=this.lastPosition[1]+this.velocity[1],this.position[0]=this.x,this.position[1]=this.y),this.angle=Math.PI/2-Math.atan(this.velocity[1]/this.velocity[0]),this.velocity[0]<0&&(this.angle=Math.PI+this.angle);for(var d=0;d<3;d++)this.acceleration[d]=0},test:function(a,b){if(this.isStatic&&a.isStatic)return!1;var c=this.x,d=this.y,e=this.radius,f=a.x,g=a.y,h=a.radius,i=b,j;j=Math.pow(c-f,2)+Math.pow(d-g,2);if(j<Math.pow(e+h,2)){i.ingression=j=Math.mag(c-f,d-g),i.weight=e+h,i.distance=i.ingression-i.weight;var k=c-f,l=d-g,m=j,n=(m-e)/m,o=h/m;return i.px=f+Math.lerp(0,k,n),i.py=g+Math.lerp(0,l,n),i.qx=f+Math.lerp(0,k,o),i.qy=g+Math.lerp(0,l,o),!0}return!1},solve:function(a,b){var c=this,d=a,e=b,f=(e.qx-e.px)*.5,g=(e.qy-e.py)*.5,h=c.mass,i=d.mass,j=h+i,k=i/j,l=h/j,m=c.lx-c.x,n=c.ly-c.y,o=Math.mag(m,n),p=d.lx-d.x,q=d.ly-d.y,r=Math.mag(p,q),s=Math.abs(e.distance)*c.friction*d.friction;o!=0&&(m=m/o*(o-s),n=n/o*(o-s)),r!=0&&(p=p/r*(r-s),q=q/r*(r-s)),c.isStatic?(k=0,l=1):d.isStatic&&(k=1,l=0);var t=!0;c.isTrigger&&(c.call("collision",d,e),t=b.solve||!1,delete b.solve),d.isTrigger&&(d.call("collision",c,e),t=b.solve||!1,delete b.solve),t&&(c.lastPosition[0]=c.lx=c.position[0]+m,c.lastPosition[1]=c.ly=c.position[1]+n,c.position[0]+=f*k,c.x=c.position[0],c.position[1]+=g*k,c.y=c.position[1],d.lastPosition[0]=d.lx=d.position[0]+p,d.lastPosition[1]=d.ly=d.position[1]+q,d.position[0]-=f*l,d.x=d.position[0],d.position[1]-=g*l,d.y=d.position[1])}},{isStatic:{get:function(){return!!(this.mask&i.Masks.STATIC)},set:function(a){a?this.mask|=i.Masks.STATIC:this.mask=(this.mask|i.Masks.STATIC)^i.Masks.STATIC}},isTrigger:{get:function(){return!!(this.mask&i.Masks.TRIGGER)},set:function(a){a?this.mask|=i.Masks.TRIGGER:this.mask=(this.mask|i.Masks.TRIGGER)^i.Masks.TRIGGER}}},{Masks:{LIQUID:1,SOLID:2,GAS:4,STATIC:8,TRIGGER:16,ALL:-1}}),j=g.type(g.type.Base,{init:function(a,b,c,d){this.top=a,this.right=b,this.bottom=c,this.left=d,this.width=b-d,this.height=a-c},contains:function(a){return a[0]<this.right&&a[0]>this.left&&a[1]<this.top&&a[1]>this.bottom},copy:function(){return j.create(this.top,this.right,this.bottom,this.left)},translate:function(a,b){this.top+=b,this.bottom+=b,this.left+=a,this.right+=a}}),l=g.type(g.type.Base,{init:function(a,b){this.hash={},this.arrayHash=[],this.box=a,this.newBox=b.copy(),this.lastBox=b.copy(),this.cellsWide=Math.ceil(b.width/a.width),this.cellsTall=Math.ceil(b.height/a.height);for(var c=0;c<this.cellsWide;c++)for(var d=0;d<this.cellsTall;d++)this.arrayHash[k(this,c,d)]=[]},each:function(a){var b;for(b=0;b<this.arrayHash.length;b++)this.arrayHash[b]&&a(this.arrayHash[b],Math.floor(b/this.cellsWide),b%this.cellsWide)},cell:function(a,b){return this.arrayHash[k(this,Math.floor((a-this.lastBox.left)/this.box.width),Math.floor((b-this.lastBox.bottom)/this.box.height))]},add:function(a){var b=a.x,c=a.y,d=a.radius,e=this.box.width,f=this.box.height,g=this.cellsWide,h=this.cellsTall,i=this.newBox,j=Math.floor((b+d-i.left)/e+1),l=Math.floor((c+d-i.bottom)/f+1),m,n;for(m=Math.floor((b-d-i.left)/e);m>=0&&m<g&&m<j;m++)for(n=Math.floor((c-d-i.bottom)/f);n>=0&&n<h&&n<l;n++){var o=k(this,m,n),p=this.arrayHash[o];p.push(a)}a.oldX=a.x,a.oldY=a.y},remove:function(a){var b=a.oldX,c=a.oldY,d=a.radius,e=this.box.width,f=this.box.height,g=this.cellsWide,h=this.cellsTall,i=this.lastBox,j=Math.floor((b+d-i.left)/e+1),l=Math.floor((c+d-i.bottom)/f+1),m,n;for(m=Math.floor((b-d-i.left)/e);m>=0&&m<g&&m<j;m++)for(n=Math.floor((c-d-i.bottom)/f);n>=0&&n<h&&n<l;n++){var o=k(this,m,n),p=this.arrayHash[o],q=p.indexOf(a);p[q]=p[p.length-1],p.pop()}},update:function(a){this.remove(a),this.add(a)}},{},{}),m=g.type(g.GameObject,{init:function(a){Object.getPrototypeOf(Object.getPrototypeOf(this)).init.call(this),this.particles=[],this.collision={},this.box=a,this.gravity=[0,0,0],this.gravityPosition=[500,500,0],this.gravityMass=1e5,this.fixedDelta=.02,this.timeToPlay=0,a=a.copy(),a.left-=50,a.right+=50,a.top+=50,a.bottom-=50,this.hash=l.create(j.create(50,50,0,0),a)},ongameadd:function(a){this.task=a.task(this.update.bind(this),g.Game.Priorities.LATE_UPDATE)},ongamedestroy:function(a){a.tasks.remove(this.task)},addParticle:function(a){this.particles.push(a),this.hash.add(a),a.index=this.particles.length-1},removeParticle:function(a){this.game.task(function(){var b=this.particles.indexOf(a);b!=-1&&(this.particles[b]=this.particles[this.particles.length-1],this.particles[b].index=b,this.particles.pop(),this.hash.remove(a))}.bind(this),g.Game.Priorities.GARBAGE,!1,!0)},update:function(){var a=this.fixedDelta;this.game.timing.fixedDelta=a,this.timeToPlay+=this.game.timing.delta;while(this.timeToPlay>.02)this.timeToPlay-=.02,this.game.call("fixedUpdate",this),this.step(a)},calcGravity:function(a,b){var c=[0,0,0],d=.006674*b*this.gravityMass/h.length(h.subtract(a,this.gravityPosition,c));return h.scale(h.normalize(h.subtract(this.gravityPosition,a,c),c),d,c)},step:function(a){var b=this.particles,c=this.collision,d=this.box,e=b.length,f,g,i,j;c.test=0,c.collided=0;for(f=0;f<e;f++){i=b[f];if(i.ignoreGravity){i.integrate(a);continue}var k=[0,0,0],l=6674e-7*i.mass*this.gravityMass/h.length(h.subtract(i.position,this.gravityPosition,k));h.add(i.acceleration,h.scale(h.normalize(h.subtract(this.gravityPosition,i.position,k),k),l,k),i.acceleration),i.integrate(a)}var m=0,n=[],o=this.hash;this.hash.each(function(a){m=a.length,n.splice(0,n.length);for(f=0;f<m;f++){i=a[f];for(g=f+1;g<m;g++)j=a[g],i.test(j,c)&&(i.solve(j,c),n.indexOf(i)==-1&&n.push(i),n.indexOf(j)==-1&&n.push(j))}for(f=0;f<n.length;f++)o.update(n[f])}),this.hash.newBox=this.box.copy();for(f=0;f<e;f++){i=b[f];if(i.position[0]<d.left){var p=i.position[0]-i.lastPosition[0];i.position[0]=d.right,i.lastPosition[0]=i.position[0]-p}if(i.position[0]>d.right){var p=i.position[0]-i.lastPosition[0];i.position[0]=d.left,i.lastPosition[0]=i.position[0]-p}if(i.position[1]>d.top){var q=i.position[1]-i.lastPosition[1];i.position[1]=d.bottom,i.lastPosition[1]=i.position[1]-q}if(i.position[1]<d.bottom){var q=i.position[1]-i.lastPosition[1];i.position[1]=d.top,i.lastPosition[1]=i.position[1]-q}this.hash.update(i)}this.hash.lastBox=this.box.copy()}}),n=g.type(g.Renderer,{init:function(a){this.color=a.color||[218,43,58,255],typeof this.color=="string"&&(this.color=g.color(this.color))},onadd:function(a){this.world=a},draw:function(a,b){this.shader||(a.addShader({name:"a_color",path:"shaders/a_color"}),this.shader=a.shaders.a_color);if(!this.shader.program)return;this.buffer||(this.buffer=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,this.buffer),b.bufferData(b.ARRAY_BUFFER,this.world.particles.length*6*16,b.DYNAMIC_DRAW));var f=new c(this.world.particles.length*6*16),g=new d(f),h=new e(f),i=this.world.particles,j,k=this.world.fixedDelta,l=this.shader,m=this.buffer,n=i.length,o,p,q=0,r,s,t,u,v,w,x,y,z,A,B,C=this.color[0],D=this.color[1],E=this.color[2],F=this.color[3];l.matrixLocation||(l.matrixLocation=b.getUniformLocation(l.program,"modelview_projection"),l.positionLocation=b.getAttribLocation(l.program,"a_position"),l.colorLocation=b.getAttribLocation(l.program,"a_color"),b.enableVertexAttribArray(l.positionLocation),b.enableVertexAttribArray(l.colorLocation));for(o=0;o<n;o++){j=i[o],s=j.x,t=j.y,u=j.radius;if(!j.isTrigger)for(p=0;p<24;p++)p%4===0?g[q+p]=s+(p%8>3?1:-1)*u:p%4==1&&(g[q+p]=t+((p-1)/4==2||(p-1)/4==4||(p-1)/4==5?1:-1)*u);q+=24}q=0;for(o=0;o<n;o++){j=i[o],j.isTrigger?y=z=A=B=0:(s=j.x,t=j.y,v=j.lx,w=j.ly,x=Math.mag(s-v,t-w)*2/15,y=Math.clamp(x*255,0,C),z=Math.clamp(x*255,0,D),A=Math.clamp(x*255,0,E),B=Math.clamp(x*255,0,F));for(p=0;p<96;p+=16)h[q+p+12]=y,h[q+p+13]=z,h[q+p+14]=A,h[q+p+15]=B;q+=96}b.enable(b.BLEND),a.useShader("a_color"),b.bindBuffer(b.ARRAY_BUFFER,m),b.bufferData(b.ARRAY_BUFFER,f,b.DYNAMIC_DRAW),b.uniformMatrix4fv(l.matrixLocation,!1,a.projection),b.vertexAttribPointer(l.positionLocation,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(l.colorLocation,4,b.UNSIGNED_BYTE,!0,16,12),b.drawArrays(b.TRIANGLES,0,f.byteLength/16)}});g.Particle=i,g.World=m,g.World.Renderer=n,g.Box=j})}(this,this.load),function(a,b){var c=a.when;b.module("engine/init.js",b.chain(b.script("engine/base.js"),function(){return c.all([b.script("engine/object.js"),b.script("engine/graphics.js"),b.script("engine/physics.js"),b.script("engine/sound.js")])}),function(){})}(this,this.load),function(a,b){var c=a.document,d=a.setInterval,e=a.clearInterval,f=a.when,g=a.aqua,h=g.type(g.type.Base,{init:function(){this.promises={},this.nodes={},a.webkitAudioContext&&(this.context=new a.webkitAudioContext,this.nodes={main:this.context.createGain()},this.nodes.main.connect(this.context.destination),c.addEventListener("webkitvisibilitychange",this.onvisibilitychange.bind(this)),this.onvisibilitychange())},onvisibilitychange:function(){if(c.webkitVisibilityState=="visible"){this.visibilityInterval&&e(this.visibilityInterval);var a=0,b=d(function(){this.nodes.main.gain.value=a+=g.game.timing.delta,a>.1&&(this.nodes.main.gain.value=.1,e(b))}.bind(this),50);this.visibilityInterval=b}else this.nodes.main.gain.value=0,this.visibilityInterval&&e(this.visibilityInterval)},load:function(a){if(this.promises[a.name])return this.promises[a.name];var c=f.defer(),d=b.data(a.path),e=this;return d.then(function(b){try{e._loadClip(a.name,b),c.resolve(a.name)}catch(d){c.reject(d)}},c.reject.bind(c),c.progress.bind(c)),this.promises[a.name]=c,c},_loadClip:function(a,b){var c=f.defer();return this.context.decodeAudioData(b,function(b){var d=this.nodes[a]={buffer:b};c.resolve()}.bind(this),c.reject),c.promise},play:function(a){if(this.nodes[a]){var b=this.context.createBufferSource();b.buffer=this.nodes[a].buffer,b.connect(this.nodes.main),b.start()}},_playAll:function(){this.nodes.happy.source.noteOn(0),this.nodes.zone.source.noteOn(0),this.nodes.approach.source.noteOn(0),this.nodes.happy.source.loop=!0,this.nodes.zone.source.loop=!0,this.nodes.approach.source.loop=!0,this.nodes.happy.source.gain.value=0,this.nodes.zone.source.gain.value=0,this.nodes.approach.source.gain.value=0}});g.SoundContext=h}(this,this.load),function(a,b){a.glider={},a.btb={},a.muted=!1,a.credits=!1;var c=a.when;b.module("game/main.js",b.chain(b.script("engine/init.js"),function(){return c.all([b.script("game/glider.js"),b.script("game/jet.js"),b.script("game/planet.js"),b.script("game/mail.js")])}),function(){setTimeout(function(){function n(){e.requestAnimFrame.call(null,n),e.game.step()}var $=a.$,c=a.when,d=a.mat4,e=a.aqua,f=a.glider;e.game=e.Game.create(),e.game.tallyStuff={},e.sound=e.SoundContext.create(),b.json("sounds/sounds.json").then(function(a){a=JSON.parse(a);for(var b in a)console.log(b,a[b].path),e.sound.load({name:b,path:a[b].path}).then(function(){console.log(arguments)},function(a){console.error(a.stack||a)})}),e.game.graphics=e.initGraphics($("canvas")[0]),e.game.graphics.addShader({name:"basic",path:"shaders/basic"}),e.game.task(e.game.call.bind(e.game,"render"),e.Game.Priorities.RENDER),e.game.task(e.game.graphics.draw.bind(e.game.graphics),e.Game.Priorities.RENDER),e.colors={bg:"5D7370FF",particle:"FFF5BCFF",planet:"FFF5BCFF",ship:"895F53FF",mail:[255,90,48,255]},e.game.timing={delta:0,last:Date.now()},e.game.task(function(){var a=Date.now();e.game.timing.delta=Math.clamp((a-e.game.timing.last)/1e3,0,.3),e.game.timing.last=a},-10),e.game.world=e.World.create(e.Box.create(1500,1500,0,0)),e.game.add(e.game.world),e.game.world.add(e.World.Renderer.create({color:e.colors.particle}));var g=e.Particle.create([e.game.world.box.width/2,e.game.world.box.height/2,0],50,1);e.game.world.gravityPosition=g.position,g.isStatic=!0,g.isTrigger=!0,g.isPlanet=!0,e.game.world.addParticle(g),e.game.world.planet=g;var h=e.GameObject.create();h.add(f.ParticleRenderer.create({particle:g,color:e.colors.planet})),h.add(f.MailGoal.create(g)),e.game.add(h),e.game.player=f.makeGlider(),e.game.add(e.game.player);for(var i=0;i<500;i++)e.game.world.addParticle(e.Particle.create([e.game.world.box.width*(i/500),Math.random()*e.game.world.box.width,0],15+Math.random()*3,1));var j,k=[];e.game.world.add(j=f.Jet.create([g.position[0]+Math.cos(Math.PI/6)*g.radius*2,g.position[1]+Math.sin(Math.PI/6)*g.radius*2,0],[Math.cos(Math.PI/6)*6e3,Math.sin(Math.PI/6)*6e3,0])),k.push(j),e.game.world.add(j=f.Jet.create([g.position[0]+Math.cos(Math.PI/6*5)*g.radius*2,g.position[1]+Math.sin(Math.PI/6*5)*g.radius*2,0],[Math.cos(Math.PI/6*5)*6e3,Math.sin(Math.PI/6*5)*6e3,0])),k.push(j),e.game.world.add(j=f.Jet.create([g.position[0]+Math.cos(Math.PI/6*9)*g.radius*2,g.position[1]+Math.sin(Math.PI/6*9)*g.radius*2,0],[Math.cos(Math.PI/6*9)*6e3,Math.sin(Math.PI/6*9)*6e3,0])),k.push(j);var l=e.GameObject.create();l.add(f.WaveManager.create({planet:g,player:e.game.player,jets:k,waveOptions:{count:20}})),e.game.add(l);var m=e.color(e.colors.bg);e.game.graphics.addDrawCall(e.PriorityItem.create(function(a,b){b.clearColor(m[0]/255,m[1]/255,m[2]/255,m[3]/255),a.useShader("basic"),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.DST_ALPHA)},-1e3,!1,!0)),e.game.graphics.addDrawCall(e.PriorityItem.create(function(b,c){var f=a.innerWidth,g=a.innerHeight,h=f/g;b.canvas.width=f,b.canvas.height=g,c.viewport(0,0,f,g);var i=e.game.world.box.width*(f/g);d.ortho(-(i-e.game.world.box.width)/2,-(i-e.game.world.box.width)/2+i,0,e.game.world.box.height,0,1e3,b.projection),c.clear(c.COLOR_BUFFER_BIT),b.useShader("basic")},-1e3)),a.onresize=function(){$("#hud").css("left",a.innerWidth/2-$("#hud").width()/2),$("#hud2").css("top",$("#title").height()-$("#wave-label").height()).css("left",a.innerWidth/2-$("#hud").width()/2+$("#hud").width()+10)},a.onresize(),n()},0)})}(this,this.load),function(a,b){var c=a.aqua,d=a.glider,e=c.type(c.Component,{init:function(a,b){this.position=a,this.force=b},onadd:function(a){this.world=a,this.particle=c.Particle.create(this.position,20,1),this.particle.isStatic=!0,this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.world.addParticle(this.particle)},oncollision:function(a,b){if(a.mail)return;a.acceleration[0]+=this.force[0],a.acceleration[1]+=this.force[1]},fixedUpdate:function(){this.particle.position=this.position}});d.Jet=e}(this,this.load),load.module("game/mail.js",when.all([load.script("engine/object.js"),load.script("engine/graphics.js")]),function(){var a=aqua.type(aqua.Component,{init:function(a,b){this.position=a||[0,0,0],this.velocity=b||[0,100,0],this.angle=0,this.inWorld=!1},ongameadd:function(a,b){this.gameObject=a,this.particle=aqua.Particle.create(this.position,10,100),this.particle.mail=this,this.particle.ignoreGravity=!0,this.launch(this.position,this.velocity),this.inWorld=!0},ongamedestroy:function(a,b){this.inWorld&&aqua.game.world.removeParticle(this.particle)},fixedUpdate:function(){this.inWorld&&(this.x=this.particle.position[0],this.y=this.particle.position[1],this.angle=Math.atan2(this.particle.y-this.particle.ly,this.particle.x-this.particle.lx))},pickup:function(){this.inWorld&&(aqua.game.world.removeParticle(this.particle),this.inWorld=!1)},launch:function(a,b){if(!this.inWorld){var c=[0,0,0];this.particle.position=vec3.create(a),this.particle.lastPosition=vec3.subtract(vec3.create(a),vec3.scale(vec3.create(b),aqua.game.world.fixedDelta,[0,0,0]),[0,0,0]),aqua.game.world.addParticle(this.particle),this.inWorld=!0}}}),b=aqua.type(aqua.Renderer,{init:function(a){this.cache={},this.color=[255,90,48,255],a&&(this.color=a.color||this.color,typeof this.color=="string"&&(this.color=aqua.color(this.color)))},onadd:function(b){this.move=b.get(a)},ongamedestroy:function(){aqua.Renderer.prototype.ongamedestroy.apply(this,arguments),this.destroyCache()},destroyCache:function(){this.graphics&&this.graphics.destroyCache(this.cache)},draw:function(a,b){a.drawSquare({center:this.move.particle.position,size:[18,10],angle:this.move.angle,color:this.color,cache:this.cache})}}),c=aqua.type(aqua.Component,{init:function(){this.mailpackets=[],this.fireTimeout=0,this.bestChain=parseInt(localStorage.bestChain||0,10),$("#best-chain").text(this.bestChain)},onadd:function(a){this.glider=a.get(glider.GliderMove),this.glider.on("onGliderCollision",this.onGliderCollision.bind(this)),this.glider.on("death",this.onGliderDeath.bind(this))},onGliderCollision:function(a,b,c){b.mail&&b.mail.inWorld&&(aqua.sound&&aqua.sound.play("pickup"),this.mailpackets.push(b.mail),b.mail.pickup(),b.mail.call("destroyCache"),$("#chain").text(this.mailpackets.length),this.mailpackets.length>this.bestChain&&(this.bestChain=this.mailpackets.length,$("#best-chain").text(this.bestChain),localStorage.bestChain=this.bestChain.toString()))},onGliderDeath:function(){while(this.mailpackets.length){var a=this.mailpackets.pop();a.launch([a.x,a.y,0],[Math.random()*30-15,Math.random()*30-15,0])}$("#chain").text(this.mailpackets.length)},fixedUpdate:function(){this.fireTimeout-=aqua.game.world.fixedDelta;if(this.glider.playing&&this.fireTimeout<0){var a=aqua.game.world.planet,b=vec3.direction(a.position,this.glider.particle.position,vec3.create()),c=Math.atan2(b[1],b[0]),d=c+Math.PI/2,e=Math.cos(d),f=Math.sin(d),g=vec3.add(a.position,[e*a.radius*.8,f*a.radius*.8,0],vec3.create()),h=vec3.direction(g,this.glider.particle.position,vec3.create());farAngle=Math.acos(vec3.dot(h,b)/(vec3.length(h)*vec3.length(b))),shipAngleVector=[Math.cos(this.glider.angle),Math.sin(this.glider.angle),0],shipAngleToPlanet=Math.acos(vec3.dot(vec3.normalize(shipAngleVector),vec3.normalize(b)));if(shipAngleToPlanet<farAngle){if(this.mailpackets.length){this.fireTimeout=1,aqua.sound&&aqua.sound.play("launch");var i=[this.glider.vx,this.glider.vy,0],j=[Math.cos(this.glider.angle),Math.sin(this.glider.angle),0];this.mailpackets.pop().launch(vec3.add(this.glider.particle.position,[Math.cos(this.glider.angle)*(this.glider.particle.radius+20),Math.sin(this.glider.angle)*(this.glider.particle.radius+20),0],[0,0,0]),vec3.add([Math.cos(this.glider.angle)*500,Math.sin(this.glider.angle)*500,0],vec3.scale(j,vec3.dot(i,j)/vec3.dot(j,j))))}$("#chain").text(this.mailpackets.length)}}var k=this.glider.particle.position[0]-Math.cos(this.glider.angle)*this.glider.radius,l=this.glider.particle.position[1]-Math.sin(this.glider.angle)*this.glider.radius,m,n,o;for(var p=0;p<this.mailpackets.length;p++)m=this.mailpackets[p],o=Math.mag(k-m.particle.position[0],l-m.particle.position[1]),o>m.particle.radius*2&&(n=Math.atan2(l-m.particle.position[1],k-m.particle.position[0]),o-=m.particle.radius*2,k=m.x=m.particle.position[0]+=Math.cos(n)*o,l=m.y=m.particle.position[1]+=Math.sin(n)*o,m.angle=n)}});glider.MailGoal=aqua.type(aqua.Component,{init:function(a){this.particle=a,this.particle.on("collision",this.oncollision.bind(this)),this.score=0,this.multiplier=1,this.bestMultiplier=parseInt(localStorage.bestMultiplier||1,10),$("#best-multiplier").text(this.bestMultiplier+"x"),this.multiplierTimer=0,console.log("init")},ongameadd:function(a,b){this.gameObject=a,b.world.addParticle(this.particle),console.log("ongameadd")},ongamedestroy:function(a,b){b.world.removeParticle(this.particle)},oncollision:function(a,b){a.mail&&a.mail.inWorld&&(console.log("mail!"),a.mail.pickup(),aqua.game.destroy(a.mail.gameObject),a.mail.call("complete"),aqua.sound&&aqua.sound.play("score"),this.score+=1*this.multiplier,$("#score").text(this.score.toString()),this.multiplier++,$("#multiplier").text(this.multiplier+"x"),this.multiplierTimer=5,this.multiplier>this.bestMultiplier&&(this.bestMultiplier=this.multiplier,localStorage.bestMultiplier=this.bestMultiplier.toString(),$("#best-multiplier").text(this.bestMultiplier+"x"))),b.solve=!0},fixedUpdate:function(){this.multiplierTimer-=aqua.game.world.fixedDelta,this.multiplierTimer<0&&this.multiplier!==1&&(this.multiplier=1,$("#multiplier").text(this.multiplier+"x"))}}),glider.MailWave=aqua.type(aqua.Component,{init:function(a){this.packets=[],this.renderOptions=a.render||{},this.options=a},ongameadd:function(a,b){for(var c=0;c<this.options.count;c++)this.makePacket()},makePacket:function(){var a=aqua.GameObject.create(),b,c,d=Math.floor(Math.random()*4),e=this;d===0?(b=[Math.random()*aqua.game.world.box.width,aqua.game.world.box.top,0],c=[Math.random()*20-10,-20+ -Math.random()*10,0]):d===1?(b=[aqua.game.world.box.right,Math.random()*aqua.game.world.box.height,0],c=[-20+ -Math.random()*10,Math.random()*20-10,0]):d===2?(b=[Math.random()*aqua.game.world.box.width,aqua.game.world.box.bottom,0],c=[Math.random()*20-10,20+Math.random()*10,0]):d===3&&(b=[aqua.game.world.box.left,Math.random()*aqua.game.world.box.height,0],c=[20+Math.random()*10,Math.random()*20-10,0]),a.add(glider.Mail.create(b,c)),a.add(glider.MailRender.create(this.renderOptions)),aqua.game.add(a),a=a.get(glider.Mail),this.packets.push(a),a.on("complete",function(){var b=e.packets.indexOf(a);b!=-1&&(e.packets.splice(b,1),e.packets.length===0&&e.call("complete"))})}}),glider.WaveManager=aqua.type(aqua.Component,{init:function(a){this.waveCount=0,this.wave=null,this.jets=a.jets||[],this.player=a.player,this.planet=a.planet,this.options=a,this.waveOptions=a.waveOptions||{}},ongameadd:function(){this.startWave()},startWave:function(){this.wave=aqua.GameObject.create(),this.wave.add(glider.MailWave.create(this.waveOptions)),aqua.game.add(this.wave),this.wave=this.wave.get(glider.MailWave),this.wave.on("complete",this.endWave.bind(this)),this.waveCount++,$("#wave").text(this.waveCount),aqua.sound&&aqua.sound.play("wavestart")},endWave:function(){aqua.game.destroy(this.wave.gameObject),this.wave=null,this.waveOptions.count*=1.1;var a=this.jets.length;this.jets.forEach(function(b,c){var d=Math.random()*Math.PI-Math.PI*2/a/2+Math.PI*2/12*(1+c*4);b.force=[Math.cos(d)*6e3,Math.sin(d)*6e3,0]}),aqua.sound&&aqua.sound.play("waveend"),setTimeout(this.startWave.bind(this),5e3)}}),glider.Mail=a,glider.MailRender=b,glider.MailManager=c}),function(a,b){b.module("game/glider.js",null,function(){function o(a){while(a>Math.PI)a-=Math.PI*2;while(a<Math.PI)a+=Math.PI*2;return a}var c=a.document,d=a.localStorage,e=a.setTimeout,f=a.setInterval,g=a.clearInterval,h=a.ArrayBuffer,i=a.Float32Array,j=a.atob,k=a.vec3,l=a.when,$=a.$,m=a.aqua,n=a.glider,p=m.type(m.Component,{init:function(a){var b;this.inputMap=a,this.state={};for(b in a)this.state[a[b]]={pressed:!1}},onadd:function(){a.addEventListener("keydown",this._keydown=this.keydown.bind(this)),a.addEventListener("keyup",this._keyup=this.keyup.bind(this))},ondestroy:function(){a.removeEventListener("keydown",this._keydown),a.removeEventListener("keyup",this._keyup)},get:function(a){return this.state[a].pressed},getPressTime:function(a){return this.state[a].pressed&&Date.now()-this.state[a].start},keydown:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!0,b.start||(b.start=Date.now())},keyup:function(a){var b=this.state[this.inputMap[a.keyCode]];if(!b)return;b.pressed=!1,delete b.start}}),q=m.type(m.Component,{init:function(a){this.inputMap=a.inputMap||a,this.fired=!1},ongameadd:function(b,c){this._keydown=this.keydown.bind(this),a.addEventListener("keydown",this._keydown),this.game=c},keydown:function(b){this.inputMap[b.keyCode]=="up"&&!this.fired&&(a.removeEventListener("keydown",this._keydown),this.game.add(n.makeGlider()),this.game.destroy(this.gameObject),this.fired=!0)}}),r=m.type(m.Component,{init:function(){this.x=500,this.y=500,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.angle=-Math.PI/2,this.radius=25,this.score=0,this.particle=m.Particle.create([this.x,this.y,0],this.radius,1),this.particle.isTrigger=!0,this.particle.on("collision",this.oncollision.bind(this)),this.playing=!1,this.timeToLastCollision=0,this.crashTimer=-1,this.maxCrashTimer=2},onadd:function(a){this.input=a.get(p)},ondestroy:function(){this.input=null},ongameadd:function(a,b){b.world.addParticle(this.particle),this.world=b.world,this.sound=b.sound,b.call("newplayer",this)},ongamedestroy:function(a,b){b.world.removeParticle(this.particle),b.score&&b.score.setMove(null),m.game.sound&&(m.game.sound.nodes.happy.source.gain.value=1,m.game.sound.nodes.zone.source.gain.value=0,m.game.sound.nodes.approach.source.gain.value=0)},oncollision:function(a,b){if(!this.playing)return;if(a.isPlanet){this.crashTimer=0,this.particle.isTrigger=!1;var c=m.game.timing.fixedDelta,d=this;m.sound&&m.sound.play("death"),this.call("death"),m.game.task(function(){d.particle.mass=1e3,d.particle.friction=1},m.Game.Priorities.GARBAGE,!1,!0);return}var e=m.game.timing.fixedDelta,f=a.lastPosition[0]-a.position[0],g=a.lastPosition[1]-a.position[1],h=Math.sqrt(f*f+g*g),i=Math.atan2(g,f);if(isNaN(f)||isNaN(g))return;while(i>Math.PI)i-=Math.PI*2;while(i<-Math.PI)i+=Math.PI*2;var j=h*10,k=j*Math.cos(i+Math.PI-this.angle-Math.PI/2)*(Math.abs(i-this.angle)<Math.PI/2?1:0),l=Math.cos(this.angle+Math.PI/2)*k,n=Math.sin(this.angle+Math.PI/2)*k;k=j*Math.sin(i+Math.PI-this.angle-Math.PI/2)*(Math.abs(i-this.angle)>Math.PI/2?1:0),l+=Math.cos(this.angle+Math.PI)*k,n+=Math.sin(this.angle+Math.PI)*k,this.ax+=Math.clamp(l,-10,1e3),this.ay+=n,this.timeToLastCollision=0,this.call("onGliderCollision",this,a,b)},destruct:function(){this.gameObject.game.destroy(this.gameObject);if(!this.resetCreated){var a=m.GameObject.create();a.add(q.create(this.gameObject.get(p))),this.gameObject.game.add(a),this.resetCreated=!0}},fixedUpdate:function(){if(!this.playing&&this.input.get("up"))this.playing=!0,m.sound&&m.sound.play("spawn"),this.gameObject.game.score&&this.gameObject.game.score.setMove(this),this.heatmapTime=Date.now();else if(!this.playing){this.x=this.world.box.left+this.world.box.width/8*4,this.y=this.world.box.bottom+this.world.box.height/8*6;return}if(!this.particle.isTrigger){this.crashTimer+=m.game.timing.fixedDelta,this.x=this.particle.position[0],this.y=this.particle.position[1],this.crashTimer>this.maxCrashTimer&&this.destruct();return}var a=m.game.timing.fixedDelta,b=Math.sqrt(this.vx*this.vx+this.vy*this.vy),c=Math.atan2(this.vy,this.vx);while(c>Math.PI)c-=Math.PI*2;while(c<-Math.PI)c+=Math.PI*2;var d=this.gameObject.game.world.calcGravity([this.x,this.y,0],10);this.ax+=d[0],this.ay+=d[1];var e=b*10,f=e*Math.cos(c+Math.PI-this.angle-Math.PI/2)*(Math.abs(c-this.angle)<Math.PI/2?1:0),g=Math.cos(this.angle+Math.PI/2)*f,h=Math.sin(this.angle+Math.PI/2)*f;this.ax+=g,this.ay+=h,this.input.get("up")&&(this.angle+=Math.PI*a,this.x<this.world.box.left+this.world.box.width/3&&(this.ax+=Math.cos(this.angle)*50,this.ay+=Math.sin(this.angle)*50),this.y<this.world.box.bottom+this.world.box.height/8&&(this.ax+=Math.cos(this.angle)*50,this.ay+=Math.sin(this.angle)*200)),(this.timeToLastCollision+=a)>1?($("#booster").text("BOOSTERS: ON"),this.ax+=Math.cos(this.angle)*10,this.ay+=Math.sin(this.angle)*10):$("#booster").text("BOOSTERS: OFF"),this.vx+=this.ax/2*a,this.x+=this.vx*a,this.vx+=this.ax/2*a,this.vy+=this.ay/2*a,this.y+=this.vy*a,this.vy+=this.ay/2*a,k.set([this.x,this.y,0],this.particle.position),this.angle-=Math.PI*.2*a,this.angle>Math.PI&&(this.canScoreBackflip=!0);while(this.angle>Math.PI)this.angle-=Math.PI*2;while(this.angle<-Math.PI)this.angle+=Math.PI*2;this.angle>-Math.PI/4&&this.canScoreBackflip&&m.game.score&&(this.canScoreBackflip=!1,m.game.score.addTrick("Backflip",5e4)),this.ax=0,this.ay=0;var i=this.fadeHappy=Math.clamp((this.x-this.world.box.left-this.world.box.width/2)/40,0,1),j=this.fadeApproach=Math.clamp((this.x-240+this.y/8-this.world.box.left)/(this.world.box.width/6),0,1);this.fadeApproach===0&&(this.inDanger=!0),this.fadeApproach==1&&this.inDanger&&(this.inDanger=!1,m.game.score&&m.game.score.addTrick("Back for More",5e4)),this.world.box.contains([this.x,this.y])&&j>0&&(this.score+=i*this.gameObject.game.timing.delta*1e3,this.score+=(1-i)*this.gameObject.game.timing.delta*1e4),Date.now()-this.heatmapTime>1e4&&(this.heatmapTime=Date.now()),this.world.box.contains([this.x+this.radius,this.y+this.radius])||this.world.box.contains([this.x+this.radius,this.y-this.radius])||this.world.box.contains([this.x-this.radius,this.y+this.radius])||this.world.box.contains([this.x-this.radius,this.y-this.radius])||(this.x<this.world.box.left?this.x=this.world.box.right-this.radius:this.x>this.world.box.right&&(this.x=this.world.box.left+this.radius),this.y>this.world.box.top?this.y=this.world.box.bottom+this.radius:this.y<this.world.box.bottom&&(this.y=this.world.box.top-this.radius))}}),s=m.type(m.Component,{init:function(){this.score=0,this.playerName=d&&d.playerName||"Player",this.bestScore=d&&d.best&&parseInt(JSON.parse(d.best||"{}")[this.playerName],10)||0,this.zoneTime=0,this.zoneDiv=null,this.tricks=[],l(b.text("locale/en/tricks.json"),function(a){this.titles=JSON.parse(a)}.bind(this)),$(function(){this.modes={all:$("#scoremode div"),nameDiv:$("#scoremode div.name"),bestDiv:$("#scoremode div.best"),currentDiv:$("#scoremode div.current"),worldBestDiv:$("#scoremode div.world")},this.modes.nameDiv.click(this.onmodeclick.bind(this,{div:this.modes.nameDiv,setter:function(a){},init:function(a){a.text(this.playerName),a.attr("contenteditable",!0),a.attr("spellcheck",!1),a.text()=="Player"&&(a.focus(),c.execCommand("selectAll")),a.on("keydown",function(b){if(b.keyCode==91||b.keyCode==13)b.preventDefault(),a.blur()}),a.blur(function(){a.text().trim()===""&&a.text("Player"),d.playerName=a.text(),d.playerName!=this.playerName&&(this.playerName=d.playerName,this.bestScore=JSON.parse(d.best||"{}")[this.playerName]||0)}.bind(this))}})),this.modes.bestDiv.click(this.onmodeclick.bind(this,{div:this.modes.bestDiv,init:function(a){a.find(".value").text(parseInt(this.bestScore,10))}})),this.modes.currentDiv.click(this.onmodeclick.bind(this,{div:this.modes.currentDiv,setter:function(a){a.text(parseInt(this.score,10))},init:function(a){!this.move}})),this.modes.worldBestDiv.click(this.onmodeclick.bind(this,{div:this.modes.worldBestDiv,init:function(a){a.find(".value").text("loading")},setter:null})),this.playerName=="Player"?this.modes.nameDiv.click():this.modes.currentDiv.click()}.bind(this))},onmodeclick:function(a){var b=a.div,c=a.setter||function(){},d=a.init;if(!b.hasClass("off"))return;this.modes.all.addClass("off"),b.removeClass("off");var h=$(".score"),i;h.length===0?i=$('<div class="score"><div class="value">0</div><div class="rank"></div></div>').insertAfter("#scoremode"):(i=$('<div class="score start"><div class="value">0</div><div class="rank"></div></div>').insertAfter(".score"),e(function(){i.removeClass("start")},0)),typeof d=="function"&&d.call(this,i),h.addClass("off"),h[0]&&h[0].interval&&(g(h[0].interval),e(function(){h.remove()},500)),i[0].interval=f(c.bind(this,i.find(".value")),50),c.call(this,i.find(".value"))},showRank:function(a,b,c){var d=$(".score:last .rank"),e=["th","st","nd","rd","th","th","th","th","th","th"];if(!!c&&typeof c.Success=="undefined")for(var f=0;f<c.length;f++)if(c[f].Name==a&&c[f].Points==b){d.html(c[f].Rank+e[c[f].Rank%10]+"&nbsp;"+c[f].Name);break}},setMove:function(a){this.move=a;if(a==null){var b={Name:this.playerName,Points:parseInt(this.score,10),CustomData:{Name:this.playerName,Points:parseInt(this.score,10),StartTime:this.startTime,EndTime:Date.now()}},c=this.showRank.bind(this,this.playerName,parseInt(this.score,10));this.modes.currentDiv.hasClass("off")&&(c=function(){})}else this.startTime=Date.now();if(a==null&&this.score>this.bestScore&&d){this.bestScore=this.score;var e=JSON.parse(d.best||"{}")||{};e[this.playerName]=this.bestScore,d.best=JSON.stringify(e)}a&&this._clear()},_clear:function(){var a=this.tricks,b=a.length,c;for(c=0;c<b;c++)this.removeTrick(a[c]);this.score=0,this.zoneTime=0,this.zoneTimeAwarded=0,this.zoneDiv=null},getLocale:function(a){return this.titles&&this.titles[a]&&(a=this.titles[a][parseInt(Math.random()*this.titles[a].length-1,10)]),a},addTrick:function(a,b,c){c==null&&(c=2),this.score+=b,this.titles&&this.titles[a]&&(a=this.titles[a][parseInt(Math.random()*this.titles[a].length-1,10)]),a=a.replace(/ /g,"&nbsp;");var d=$('<div class="trick" style="top:'+(32+this.tricks.length*14)+'px;"><div class="value">'+b+'</div><div class="name">'+a+"</div></div>").appendTo(this.stuntDiv);d.find(".name").css("right",-d.find(".name").width()-5),d.time=c,d.points=b,this.tricks.push(d)},removeTrick:function(a){a.removing||(a.removing=!0,a.css("opacity",0),e(function(a){a.remove();var b=this.tricks.indexOf(a);b!=-1&&this.tricks.splice(b,1)}.bind(this,a),500))},ongameadd:function(a,b){this.world=b.world},ongamedestroy:function(){delete this.tricks},addZoneTrick:function(){this.zoneTime=parseInt(this.zoneTime*10,10)/10,this.addTrick(this.zoneTime+"s "+this.getLocale("in the Zone"),this.zoneTime*1e4)},fixedUpdate:function(){var b=this.gameObject.game.timing.fixedDelta,c=this.stuntDiv,d=$(".score:last"),e=$("#scoremode"),f=this.zoneDiv;c||(c=this.stuntDiv=$("#stunts")),this.move&&this.world.box.contains([this.move.x,this.move.y])?(this.move.fadeApproach>0?(this.score+=this.move.fadeHappy*b*1e3,this.score+=(1-this.move.fadeHappy)*b*1e4,this.move.fadeHappy===0?(this.zoneTime+=b,this.zoneTime-this.zoneTimeAwarded>5&&(this.zoneTimeAwarded+=5,this.addTrick(this.zoneTimeAwarded+"s "+this.getLocale("in the Zone"),this.zoneTimeAwarded*1e4))):(this.zoneTime&&this.addZoneTrick(),this.zoneTime=0,this.zoneTimeAwarded=0)):(this.zoneTime&&this.addZoneTrick(),this.zoneTime=0,this.zoneTimeAwarded=0),this.zoneTime>0&&!this.zoneDiv&&(f=this.zoneDiv=$('<div class="trick zone">0s</div>').appendTo(c),this.tricks.splice(0,0,f)),this.zoneTime===0&&this.zoneDiv&&(delete this.zoneDiv,f.time=2,f=null)):this.zoneDiv&&(delete this.zoneDiv,f.time=0,f=null),f&&f.text(parseInt(this.zoneTime*10,10)/10+"s");for(var g=0;g<this.tricks.length;g++){var h=this.tricks[g];h.css("top",32+g*14),h.time!=null&&(h.time-=b,h.time<=0&&this.removeTrick(h))}d&&c.css("left",(a.innerWidth-d.width())/2);var i=e.find("div:eq(1)").css("right",a.innerWidth/2+6);i=e.find("div:eq(0)").css("right",a.innerWidth/2+12+i.width()),i=e.find("div:eq(2)").css("left",a.innerWidth/2+3),e.find("div:eq(3)").css("left",a.innerWidth/2+9+i.width())}}),t=m.type(m.Component,{init:function(a){this.color=[255,90,48,255],a&&(this.color=a.color||this.color),typeof this.color=="string"&&(this.color=m.color(this.color))},onadd:function(a){this.move=a.get(r)},ongameadd:function(a,b){this.drawCall=m.PriorityItem.create(this.draw.bind(this)),b.graphics.addDrawCall(this.drawCall)},ongamedestroy:function(a,b){b.graphics.removeDrawCall(this.drawCall)},draw:function(a,b){this.buffer||(this.buffer=b.createBuffer(),this.arrayBuffer=new h(96),this.floatView=new i(this.arrayBuffer));var c=this.floatView,d=this.move.angle,e=this.move.x,f=this.move.y,g=this.move.radius,j=a.shaders.basic;a.useShader("basic"),j.matrixLocation||(j.matrixLocation=b.getUniformLocation(j.program,"modelview_projection"),j.texture0Location=b.getUniformLocation(j.program,"texture0"),j.colorLocation=b.getUniformLocation(j.program,"color"),j.positionLocation=b.getAttribLocation(j.program,"a_position"),j.texcoord0Location=b.getAttribLocation(j.program,"a_texcoord0"),b.enableVertexAttribArray(j.positionLocation),b.enableVertexAttribArray(j.texcoord0Location)),c[0]=e+Math.cos(d)*g,c[1]=f+Math.sin(d)*g,c[4]=e+Math.cos(d+Math.PI)*g,c[5]=f+Math.sin(d+Math.PI)*g,c[8]=c[4]+Math.cos(d+Math.PI/4*3)*g/3*2,c[9]=c[5]+Math.sin(d+Math.PI/4*3)*g/3*2,c[12]=c[0],c[13]=c[1],c[16]=c[8],c[17]=c[9],c[20]=c[0]+Math.cos(d+Math.PI/4*3)*g/3*4,c[21]=c[1]+Math.sin(d+Math.PI/4*3)*g/3*4,b.bindBuffer(b.ARRAY_BUFFER,this.buffer),b.bufferData(b.ARRAY_BUFFER,c,b.DYNAMIC_DRAW),b.uniformMatrix4fv(j.matrixLocation,!1,a.projection),b.uniform4f(j.colorLocation,this.color[0]/255,this.color[1]/255,this.color[2]/255,this.color[3]/255*(this.move.crashTimer>=0?(this.move.maxCrashTimer-this.move.crashTimer)/this.move.maxCrashTimer:1)),b.uniform1i(j.texture0Location,0),b.vertexAttribPointer(j.positionLocation,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(j.texcoord0Location,2,b.FLOAT,!1,16,8),b.drawArrays(b.TRIANGLES,0,6)}});n.GliderScore=s,n.GliderReset=q,n.GliderInput=p,n.GliderMove=r,n.GliderRender=t,n.makeGlider=function(a){return a=a||m.GameObject.create(),a.add(p.create({87:"up",38:"up",32:"up"})),a.add(r.create()),a.add(t.create({color:m.colors.ship})),n.MailManager&&a.add(n.MailManager.create()),a}})}(this,this.load),load.module("game/planet.js",load.script("engine/graphics.js"),function(){var a=aqua.type(aqua.Renderer,{init:function(a){this.particle=a.particle,this.color=a.color||"FFFFFFFF",typeof this.color=="string"&&(this.color=aqua.color(this.color))},onadd:function(a){this.world=a},ongameadd:function(a,b){this.drawCall=aqua.PriorityItem.create(this.draw.bind(this)),b.graphics.addDrawCall(this.drawCall)},ongamedestroy:function(a,b){b.graphics.removeDrawCall(this.drawCall)},draw:function(a,b){this.shader||(a.addShader({name:"a_color",path:"shaders/a_color"}),this.shader=a.shaders.a_color);if(!this.shader.program)return;var c=12;this.buffer||(this.buffer=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,this.buffer),b.bufferData(b.ARRAY_BUFFER,(2+c)*16,b.DYNAMIC_DRAW));var d=new ArrayBuffer((2+c)*16),e=new Float32Array(d),f=new Uint8Array(d),g,h=this.shader,i=this.buffer,j,k,l=0,m,n,o,p,q,r,s,t=this.color[0],u=this.color[1],v=this.color[2],w=this.color[3];h.matrixLocation||(h.matrixLocation=b.getUniformLocation(h.program,"modelview_projection"),h.positionLocation=b.getAttribLocation(h.program,"a_position"),h.colorLocation=b.getAttribLocation(h.program,"a_color"),b.enableVertexAttribArray(h.positionLocation),b.enableVertexAttribArray(h.colorLocation)),g=this.particle,e[0]=g.position[0],e[1]=g.position[1],f[12]=t,f[13]=u,f[14]=v,f[15]=w;for(var j=0;j<c+1;j++)e[(j+1)*4]=g.position[0]+Math.cos(Math.PI*j/c*2)*g.radius,e[(j+1)*4+1]=g.position[1]+Math.sin(Math.PI*j/c*2)*g.radius,f[(j+1)*16+12]=t,f[(j+1)*16+13]=u,f[(j+1)*16+14]=v,f[(j+1)*16+15]=w;a.useShader("a_color"),b.bindBuffer(b.ARRAY_BUFFER,i),b.bufferData(b.ARRAY_BUFFER,d,b.DYNAMIC_DRAW),b.uniformMatrix4fv(h.matrixLocation,!1,a.projection),b.vertexAttribPointer(h.positionLocation,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(h.colorLocation,4,b.UNSIGNED_BYTE,!0,16,12),b.drawArrays(b.TRIANGLE_FAN,0,c+2)}});glider.ParticleRenderer=a})